### Модели множественного выбора {#multchoice}




Загрузим необходимые пакеты.

```r
library(tidyverse) # для манипуляций с данными и построения графиков
library(skimr) # для красивого summary
library(rio) # для чтения .dta файлов
library(margins) # для расчета предельных эффектов
library(mlogit)
library(skimr)
library(nnet)
library(questionr)
library(MASS)
library(survival)
library(lattice)
```

## r

Импортируем датасет. В нем находятся данные по клиентам пенсионных фондов. Нас интересует переменная `pctstck`, которая принимает три значения: 0, 50, 100 - в зависимоcти от ответа респондента на вопрос о предпочтительном способе инвестирования пенсионных накоплений.   


```r
df = rio::import("data/pension.dta")
```


```r
skim_with(numeric = list(hist = NULL, p25 = NULL, p75 = NULL)) #посмотрим на данные

skim(df)
```

```
Skim summary statistics
 n obs: 226 
 n variables: 19 

── Variable type:numeric ───────────────────────────────────────────────────────────────────
 variable missing complete   n     mean      sd   p0     p50 p100
      age       0      226 226   60.7      4.29   53   60      73
    black       0      226 226    0.12     0.33    0    0       1
   choice       0      226 226    0.62     0.49    0    1       1
     educ       7      219 226   13.52     2.55    8   12      18
   female       0      226 226    0.6      0.49    0    1       1
  finc100      10      216 226    0.12     0.33    0    0       1
  finc101      10      216 226    0.065    0.25    0    0       1
   finc25      10      216 226    0.21     0.41    0    0       1
   finc35      10      216 226    0.19     0.39    0    0       1
   finc50      10      216 226    0.25     0.43    0    0       1
   finc75      10      216 226    0.12     0.33    0    0       1
       id       0      226 226 2445.09  1371.27   38 2377.5  5014
  irain89       0      226 226    0.5      0.5     0    0.5     1
  married       0      226 226    0.73     0.44    0    1       1
  pctstck       0      226 226   46.68    39.44    0   50     100
  prftshr      20      206 226    0.21     0.41    0    0       1
   pyears       8      218 226   11.39     9.61    0    9      45
 stckin89       0      226 226    0.32     0.47    0    0       1
 wealth89       0      226 226  197.91   242.09 -580  127.85 1485
```


Создадим факторную перменную и упорядочим категории. 


```r
df = mutate(df, y = factor(pctstck)) # факторная переменная
df = mutate(df, y = relevel(y, ref = 1)) # сменить базовую категорию
levels(df$y)
```

```
[1] "0"   "50"  "100"
```

Можно взглянуть на значения объясняемой переменной в разрезе какой-то другой переменной. Или посмотреть на картиночку.


```r
table(df$y, df$educ)
```

```
     
       8  9 10 11 12 13 14 15 16 17 18
  0    5  3  0  3 31  4  7  0 11  1  7
  50   1  1  0  3 34  4  6  2 14  5 14
  100  0  2  1  1 36  1  5  4  5  4  4
```

```r
tab = xtabs(~ y + educ, data = df)
prop.table(tab, 1)
```

```
     educ
y              8          9         10         11         12         13
  0   0.06944444 0.04166667 0.00000000 0.04166667 0.43055556 0.05555556
  50  0.01190476 0.01190476 0.00000000 0.03571429 0.40476190 0.04761905
  100 0.00000000 0.03174603 0.01587302 0.01587302 0.57142857 0.01587302
     educ
y             14         15         16         17         18
  0   0.09722222 0.00000000 0.15277778 0.01388889 0.09722222
  50  0.07142857 0.02380952 0.16666667 0.05952381 0.16666667
  100 0.07936508 0.06349206 0.07936508 0.06349206 0.06349206
```

```r
spineplot(tab, off = 0)
```

<img src="04-multinom_choice_files/figure-html/unnamed-chunk-1-1.png" width="672" />

Построим модель множественного выбора (лог-линейная модель). 


```r
multmodel= multinom(y ~ choice+age+educ+wealth89+prftshr, data = df, reflevel = '50')
```

```
# weights:  21 (12 variable)
initial  value 220.821070 
iter  10 value 207.012642
iter  20 value 204.507792
final  value 204.507779 
converged
```

```r
summary(multmodel)
```

```
Call:
multinom(formula = y ~ choice + age + educ + wealth89 + prftshr, 
    data = df, reflevel = "50")

Coefficients:
    (Intercept)    choice         age       educ      wealth89    prftshr
50     3.777686 0.6269410 -0.10621691 0.18518113 -0.0003716626 -0.2717872
100    4.492971 0.6244954 -0.09482129 0.04644315 -0.0003548369  0.9809245

Std. Errors:
    (Intercept)    choice        age       educ     wealth89   prftshr
50     1.581691 0.3701263 0.02826469 0.06725443 0.0007365833 0.4988234
100    1.385291 0.3851273 0.02530600 0.07203058 0.0007896235 0.4396202

Residual Deviance: 409.0156 
AIC: 433.0156 
```

При необходимости можем построить модельку для подвыборки, например, только для замужних/женатых.


```r
multmodel_married = multinom(y ~ choice+age+educ+wealth89+prftshr, subset = married == 1, data = df, reflevel = '50')
```

```
# weights:  21 (12 variable)
initial  value 165.890456 
iter  10 value 152.737765
iter  20 value 149.611359
final  value 149.611069 
converged
```

```r
summary(multmodel_married)
```

```
Call:
multinom(formula = y ~ choice + age + educ + wealth89 + prftshr, 
    data = df, subset = married == 1, reflevel = "50")

Coefficients:
    (Intercept)    choice        age       educ      wealth89   prftshr
50     4.907315 1.0040978 -0.1279041 0.19054837 -0.0006204112 0.1901337
100    5.135424 0.4658502 -0.1145570 0.09046898 -0.0002127724 1.2594092

Std. Errors:
    (Intercept)    choice        age       educ     wealth89   prftshr
50     1.836616 0.4462543 0.03282248 0.07841324 0.0008456801 0.5624022
100    1.551829 0.4583930 0.02890949 0.08508466 0.0008605946 0.5228806

Residual Deviance: 299.2221 
AIC: 323.2221 
```

Быстренько прикинули значимость коэффициентов.


```r
summary(multmodel)$coefficients/summary(multmodel)$standard.errors
```

```
    (Intercept)   choice       age      educ   wealth89    prftshr
50     2.388384 1.693857 -3.757937 2.7534413 -0.5045765 -0.5448566
100    3.243342 1.621530 -3.746989 0.6447699 -0.4493748  2.2313001
```

Сохраним прогнозы.

```r
fit_values = fitted(multmodel)
```

И посчитать относительное изменение отношения шансов:

\[
\frac{P(y_{i} = j)}{P(y_{i} = 1)} = exp(x_{i}\beta)
\] - показывает изменение отношения шансов при выборе альтернативы j вместо альтернативы 0, если x изменился на единицу


```r
odds.ratio(multmodel) 
```

```
                      OR    2.5 %    97.5 %         p    
50/(Intercept)  43.71476  1.96920  970.4342 0.0169227 *  
50/choice        1.87188  0.90620    3.8666 0.0902925 .  
50/age           0.89923  0.85077    0.9505 0.0001713 ***
50/educ          1.20344  1.05481    1.3730 0.0058972 ** 
50/wealth89      0.99963  0.99819    1.0011 0.6138563    
50/prftshr       0.76202  0.28666    2.0256 0.5858522    
100/(Intercept) 89.38659  5.91713 1350.3111 0.0011814 ** 
100/choice       1.86730  0.87780    3.9722 0.1049041    
100/age          0.90954  0.86552    0.9558 0.0001790 ***
100/educ         1.04754  0.90961    1.2064 0.5190763    
100/wealth89     0.99965  0.99810    1.0012 0.6531613    
100/prftshr      2.66692  1.12669    6.3127 0.0256613 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
```


Можем посчитать предельные эффекты в различных квартилях. 


```r
summary(marginal_effects(multmodel)) 
```

```
  dydx_choice          dydx_age         dydx_educ        
 Min.   :-0.15646   Min.   :0.00887   Min.   :-0.036761  
 1st Qu.:-0.15043   1st Qu.:0.01777   1st Qu.:-0.029252  
 Median :-0.12909   Median :0.02075   Median :-0.025701  
 Mean   :-0.12697   Mean   :0.02049   Mean   :-0.024735  
 3rd Qu.:-0.10976   3rd Qu.:0.02411   3rd Qu.:-0.020634  
 Max.   :-0.05576   Max.   :0.02562   Max.   :-0.009214  
 dydx_wealth89        dydx_prftshr      
 Min.   :3.225e-05   Min.   :-0.177629  
 1st Qu.:6.389e-05   1st Qu.:-0.075981  
 Median :7.515e-05   Median :-0.056485  
 Mean   :7.385e-05   Mean   :-0.060746  
 3rd Qu.:8.726e-05   3rd Qu.:-0.023855  
 Max.   :9.123e-05   Max.   :-0.002558  
```

Допустим, мы можем упорядочить наши альтернативы (например, от более рискованного способа распределения ресурсов до менее). Тогда воспользуемся моделью упорядоченного выбора.


```r
logit.polr = polr(y ~ choice+age+educ+wealth89+prftshr , data = df)
probit.polr = polr(y ~ choice+age+educ+wealth89+prftshr , data = df, method = 'probit') 


### summary(logit.polr) не работает
```


```r
fit_prob = fitted(logit.polr)
fit_log = fitted(probit.polr)
```

## stata




```stata
use data/pension.dta
```

``````


```stata
sum
```

```
    Variable |        Obs        Mean    Std. Dev.       Min        Max
-------------+---------------------------------------------------------
          id |        226    2445.093    1371.271         38       5014
      pyears |        218    11.38532    9.605498          0         45
     prftshr |        206    .2087379    .4073967          0          1
      choice |        226    .6150442     .487665          0          1
      female |        226    .6017699      .49062          0          1
-------------+---------------------------------------------------------
     married |        226    .7345133    .4425723          0          1
         age |        226    60.70354    4.287002         53         73
        educ |        219    13.51598    2.554627          8         18
      finc25 |        216    .2083333    .4070598          0          1
      finc35 |        216    .1851852      .38935          0          1
-------------+---------------------------------------------------------
      finc50 |        216    .2453704    .4313061          0          1
      finc75 |        216        .125    .3314871          0          1
     finc100 |        216    .1203704      .32615          0          1
     finc101 |        216    .0648148    .2467707          0          1
    wealth89 |        226    197.9057    242.0919   -579.997   1484.997
-------------+---------------------------------------------------------
       black |        226     .119469    .3250596          0          1
    stckin89 |        226    .3185841    .4669616          0          1
     irain89 |        226          .5    .5011099          0          1
     pctstck |        226    46.68142    39.44116          0        100
```



```stata
ren pctstck y
```

``````

Построим модель множественного выбора (лог-линейная модель). 

```stata
mlogit y choice age educ wealth89 prftshr,  baseoutcome(0) 
```

```
Iteration 0:   log likelihood = -219.86356  
Iteration 1:   log likelihood = -204.58172  
Iteration 2:   log likelihood =  -204.5078  
Iteration 3:   log likelihood = -204.50778  
Iteration 4:   log likelihood = -204.50778  

Multinomial logistic regression                 Number of obs     =        201
                                                LR chi2(10)       =      30.71
                                                Prob > chi2       =     0.0007
Log likelihood = -204.50778                     Pseudo R2         =     0.0698

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
0            |  (base outcome)
-------------+----------------------------------------------------------------
50           |
      choice |   .6269473   .3706065     1.69   0.091    -.0994281    1.353323
         age |  -.1062189   .0434194    -2.45   0.014    -.1913193   -.0211185
        educ |   .1851821    .070641     2.62   0.009     .0467283    .3236359
    wealth89 |  -.0003717   .0007432    -0.50   0.617    -.0018283     .001085
     prftshr |  -.2718087   .4988312    -0.54   0.586      -1.2495    .7058825
       _cons |   3.777798   2.790118     1.35   0.176    -1.690732    9.246328
-------------+----------------------------------------------------------------
100          |
      choice |   .6244907   .3859169     1.62   0.106    -.1318925    1.380874
         age |  -.0948282   .0450488    -2.11   0.035    -.1831222   -.0065341
        educ |   .0464378   .0767858     0.60   0.545    -.1040595    .1969352
    wealth89 |  -.0003548    .000797    -0.45   0.656     -.001917    .0012074
     prftshr |   .9809114   .4396226     2.23   0.026      .119267    1.842556
       _cons |   4.493463   2.967396     1.51   0.130    -1.322526    10.30945
------------------------------------------------------------------------------
```

Можем посмотреть на прогнозы.


```stata
predict p1 p2 p3, p
```

```
(25 missing values generated)
```

И посчитать относительное изменение отношения шансов:

\[
\frac{P(y_{i} = j)}{P(y_{i} = 1)} = exp(x_{i}\beta)
\] - показывает изменение отношения шансов при выборе альтернативы j вместо альтернативы 0, если x изменился на единицу.
В stata, в отличие от R, отношение шансов называется relative-risk ratio.


```stata
mlogit, rrr
```

```
Multinomial logistic regression                 Number of obs     =        201
                                                LR chi2(10)       =      30.71
                                                Prob > chi2       =     0.0007
Log likelihood = -204.50778                     Pseudo R2         =     0.0698

------------------------------------------------------------------------------
           y |        RRR   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
0            |  (base outcome)
-------------+----------------------------------------------------------------
50           |
      choice |   1.871888   .6937337     1.69   0.091     .9053551    3.870264
         age |   .8992278   .0390439    -2.45   0.014     .8258688     .979103
        educ |   1.203438    .085012     2.62   0.009     1.047837    1.382144
    wealth89 |   .9996284   .0007429    -0.50   0.617     .9981733    1.001086
     prftshr |       .762   .3801094    -0.54   0.586     .2866481    2.025633
       _cons |   43.71966    121.983     1.35   0.176     .1843845    10366.43
-------------+----------------------------------------------------------------
100          |
      choice |   1.867295   .7206205     1.62   0.106     .8764352    3.978377
         age |   .9095292   .0409732    -2.11   0.035     .8326664    .9934872
        educ |   1.047533   .0804356     0.60   0.545     .9011717    1.217665
    wealth89 |   .9996452   .0007968    -0.45   0.656     .9980848    1.001208
     prftshr |   2.666886   1.172423     2.23   0.026     1.126671    6.312652
       _cons |   89.43064   265.3761     1.51   0.130     .2664612    30015.02
------------------------------------------------------------------------------
```


Можем посчитать предельные эффекты в разных точках.


```stata
margins, predict(outcome(50)) dydx(choice age educ wealth89 prftshr) atmeans 

margins, predict(outcome(50)) dydx(choice age educ wealth89 prftshr) at((p25) *)
```

```
Conditional marginal effects                    Number of obs     =        201
Model VCE    : OIM

Expression   : Pr(y==50), predict(outcome(50))
dy/dx w.r.t. : choice age educ wealth89 prftshr
at           : choice          =    .6069652 (mean)
               age             =    60.52736 (mean)
               educ            =    13.56219 (mean)
               wealth89        =    205.5467 (mean)
               prftshr         =    .2089552 (mean)

------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
      choice |    .077144   .0757102     1.02   0.308    -.0712453    .2255333
         age |   -.014281   .0089754    -1.59   0.112    -.0318725    .0033105
        educ |   .0380169   .0140813     2.70   0.007     .0104182    .0656157
    wealth89 |  -.0000474   .0001544    -0.31   0.759      -.00035    .0002551
     prftshr |  -.1715698   .0989457    -1.73   0.083    -.3654998    .0223602
------------------------------------------------------------------------------


Conditional marginal effects                    Number of obs     =        201
Model VCE    : OIM

Expression   : Pr(y==50), predict(outcome(50))
dy/dx w.r.t. : choice age educ wealth89 prftshr
at           : choice          =           0 (p25)
               age             =          57 (p25)
               educ            =          12 (p25)
               wealth89        =        65.1 (p25)
               prftshr         =           0 (p25)

------------------------------------------------------------------------------
             |            Delta-method
             |      dy/dx   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
      choice |   .0853087   .0708501     1.20   0.229    -.0535549    .2241723
         age |  -.0154741   .0095391    -1.62   0.105    -.0341705    .0032222
        educ |   .0380373   .0133192     2.86   0.004     .0119321    .0641426
    wealth89 |   -.000052    .000152    -0.34   0.732      -.00035     .000246
     prftshr |  -.1534241     .10697    -1.43   0.151    -.3630814    .0562333
------------------------------------------------------------------------------
```


Допустим, мы можем упорядочить наши альтернативы (например, от более рискованного способа распределения ресурсов до менее). Тогда воспользуемся моделью упорядоченного выбора.


```stata
oprobit y choice age educ wealth89 prftshr

ologit y choice age educ wealth89 prftshr
```

```
Iteration 0:   log likelihood = -219.86356  
Iteration 1:   log likelihood = -212.89234  
Iteration 2:   log likelihood = -212.88817  
Iteration 3:   log likelihood = -212.88817  

Ordered probit regression                       Number of obs     =        201
                                                LR chi2(5)        =      13.95
                                                Prob > chi2       =     0.0159
Log likelihood = -212.88817                     Pseudo R2         =     0.0317

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
      choice |   .2932272    .167064     1.76   0.079    -.0342122    .6206666
         age |  -.0453065   .0195009    -2.32   0.020    -.0835275   -.0070854
        educ |   .0269375   .0315643     0.85   0.393    -.0349273    .0888024
    wealth89 |  -.0001694   .0003431    -0.49   0.622    -.0008419    .0005031
     prftshr |   .4864833   .2030406     2.40   0.017      .088531    .8844355
-------------+----------------------------------------------------------------
       /cut1 |  -2.578052   1.277878                     -5.082648   -.0734562
       /cut2 |  -1.561798   1.272756                     -4.056353    .9327576
------------------------------------------------------------------------------


Iteration 0:   log likelihood = -219.86356  
Iteration 1:   log likelihood = -212.75117  
Iteration 2:   log likelihood = -212.72813  
Iteration 3:   log likelihood = -212.72813  

Ordered logistic regression                     Number of obs     =        201
                                                LR chi2(5)        =      14.27
                                                Prob > chi2       =     0.0140
Log likelihood = -212.72813                     Pseudo R2         =     0.0325

------------------------------------------------------------------------------
           y |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
      choice |   .4720438   .2757545     1.71   0.087     -.068425    1.012513
         age |  -.0776337   .0328659    -2.36   0.018    -.1420497   -.0132177
        educ |   .0475714   .0514763     0.92   0.355    -.0533203    .1484631
    wealth89 |   -.000277    .000561    -0.49   0.621    -.0013765    .0008224
     prftshr |   .8312158   .3506528     2.37   0.018     .1439489    1.518483
-------------+----------------------------------------------------------------
       /cut1 |  -4.376271   2.144494                     -8.579402   -.1731395
       /cut2 |  -2.714186   2.129423                     -6.887779    1.459407
------------------------------------------------------------------------------
```



