# Модели множественного выбора {#multchoice}


```{r stata_py_setup, include=FALSE}
library(knitr) # комбинирование кода и текста
library(Statamarkdown) # взаимодействие со статой
library(reticulate) # взаимодействие с питоном

if (Sys.getenv("USER") == "boris") {
  stataexe <- find_stata()
}

if (Sys.getenv("USERNAME") == "Yuliya") {
  use_python("/Users/Юлия/AppData/Local/Programs/Python/Python37/python.exe")
  stataexe <- find_stata()
}

if (Sys.getenv("USER") == "Sasha") {
  use_python('/Users/Sasha/anaconda3/bin/python3')
  stataexe = "/Applications/Stata/StataSE.app/Contents/MacOS/stataSE"
}


if (Sys.getenv("USERNAME") == "Anastasia Karpova") {
  Sys.setenv(language = "russian")

  Sys.setenv(PATH = paste("C:/Users/DNS/Anaconda3/Library/bin",
                       Sys.getenv()["PATH"], sep = ";"))
  Sys.setenv(PATH = paste("C:/Users/DNS/Anaconda3/Scripts",
                       Sys.getenv()["PATH"], sep = ";"))
  Sys.setenv(PATH = paste("C:/Users/DNS/Anaconda3/",
                       Sys.getenv()["PATH"], sep = ";"))

  use_condaenv("base")
  use_python("C:/Users/DNS/Anaconda3/python.exe")
  pandas = reticulate::import("pandas")
  stataexe = "C:/Program Files (x86)/Stata13/StataMP-64.exe"
}

if (Sys.getenv("USERNAME") == "The_sun") {
  use_python("Users/The_sun/Anaconda3/python.exe")
  stataexe = "C:/Program Files (x86)/Stata13/StataMP-64.exe"
}


knitr::opts_chunk$set(engine.path = list(stata = stataexe), collectcode = TRUE)
```

Загрузим необходимые пакеты.
```{r "library", results='hide', message=FALSE, warning=FALSE}
library(tidyverse) # для манипуляций с данными и построения графиков
library(skimr) # для красивого summary
library(rio) # для чтения .dta файлов
library(margins) # для расчета предельных эффектов
library(mlogit)
library(skimr)
library(nnet)
library(questionr)
library(MASS)
library(survival)
library(lattice)

```

## r

Импортируем датасет. В нем находятся данные по клиентам пенсионных фондов. Нас интересует переменная `pctstck`, которая принимает три значения: 0, 50, 100 - в зависимоcти от ответа респондента на вопрос о предпочтительном способе инвестирования пенсионных накоплений - в облигации, смешанный способ и в акции.   
```{r "import data r", message=FALSE, warning=FALSE}
df = rio::import("data/pension.dta")
```

Начнем с пристального взгляда на описательные статистки. 
```{r "skim",  message=FALSE, warning=FALSE}
skim_with(numeric = list(p25 = NULL, p75 = NULL)) 
skim(df)
```

Отсюда несложно заметить, что переменная `choice` - бинарная. И принимает значение `1`, если индивид в выборке имел право выбора схемы инвестирования. Переменнная `wealth98` - чистое богатство пенсионеров на 1989 год. Остальные переменные нас пока что не интересуют :)


Для начала разберемся с объясняемой переменной. Превратим её в факторную и упорядочим категории. 
```{r "factor_var",  message=FALSE, warning=FALSE}
df = mutate(df, y = factor(pctstck)) # факторная переменная
df = mutate(df, y = relevel(y, ref = 2)) # сменить базовую категорию
levels(df$y)
```

Можно взглянуть на значения объясняемой переменной в разрезе какой-то другой переменной. 
```{r, message=FALSE, warning=FALSE }
table(df$y, df$educ)
```

Построим модель множественного выбора (лог-линейная модель). 

```{r "model r",  message=FALSE, warning=FALSE}
multmodel = multinom(y ~ choice+age+educ+wealth89+prftshr, data = df, reflevel = '0')

summary(multmodel)
```

При необходимости можем построить модельку для подвыборки, например, только для замужних/женатых.
```{r "married", message=FALSE, warning=FALSE}
multmodel_married = multinom(y ~ choice+age+educ+wealth89+prftshr, subset = married == 1, data = df, reflevel = '0')
summary(multmodel_married)
```

Быстренько прикинули значимость коэффициентов.
```{r, message=FALSE, warning=FALSE}
coef(multmodel)/summary(multmodel)$standard.errors
```

Сохраним прогнозы.
```{r "fit r",  message=FALSE, warning=FALSE}
fit_values = fitted(multmodel)
```

И посчитать относительное изменение отношения шансов:

\[
\frac{P(y_{i} = j)}{P(y_{i} = 1)} = exp(x_{i}\beta)
\] - показывает изменение отношения шансов при выборе альтернативы j вместо базовой альтернативы 1, если x изменился на единицу

```{r "or",  message=FALSE, warning=FALSE}
odds.ratio(multmodel) 
```


Можем посчитать предельные эффекты в различных квартилях.
```{r "me",  message=FALSE, warning=FALSE}
summary(marginal_effects(multmodel))
```

Или при заданном значении объясняемых переменных.
```{r "me_at",  message=FALSE, warning=FALSE}
margins(multmodel,at = list(age = 69, choice = 1))
```


Теперь посмотрим на модель упорядоченного выбора :) Для нее возьмем другие данные. Выборку позаимствуем из опроса NLSY (National Longitudinal Survey of Youth). В ней представлены данные о 3705 молодых белых женщинах из США.
Зависимая переменная tradrole – степень согласия с утверждением «Место женщины дома, а не на работе» по четырехбалльной шкале (1 – категорически не согласна, 2 – не согласна, 3 – согласна, 4 – совершенно согласна).

```{r "import tradrole r",  message=FALSE, warning=FALSE}
data_nlsy = import('data/tradrole.dta')
#skim(data_nlsy)
```

```{r "hist tradrole r",  message=FALSE, warning=FALSE}
ggplot(data_nlsy, aes(x = tradrole)) + 
  geom_histogram() + 
  ggtitle('Вот такие дела, джентельмены :)')
```

Посмотрим, как влияет религиозное воспитание (`cath` - католичество и `fpro` - протестанство), число лет образования матери - `meduc` и проживание в крупном городе `urb` на объясняемую переменную.
```{r "ordered r",  message=FALSE, warning=FALSE}
oprobit <- polr(as.factor(tradrole) ~  as.factor(cath) + as.factor(fpro) + meduc + as.factor(urb), data = data_nlsy, method="probit", na.action = na.omit)
summary(oprobit)
```

В summary видим коэффициенты при регрессорах и коэффициенты при константах для каждой из упорядоченных альтернатив.
```{r "summary r",  message=FALSE, warning=FALSE}
summary(oprobit)
```

## stata

```{stata, include=FALSE}
clear all
```

```{stata "import data stata", message=FALSE, warning=FALSE}
use data/pension.dta
```

```{stata "sum",  message=FALSE, warning=FALSE}
sum
```


```{stata "ren",  message=FALSE, warning=FALSE}
ren pctstck y
```

Построим модель множественного выбора (лог-линейная модель). 
```{stata "mlogit",  message=FALSE, warning=FALSE}
mlogit y choice age educ wealth89 prftshr,  baseoutcome(0) 
```

Кросс - табличка для объясняемой переменной и числа лет образования.
```{stata, message=FALSE, warning=FALSE }
table y educ
```

Можем посмотреть на прогнозы.
```{stata "predict",  message=FALSE, warning=FALSE}
predict p1 p2 p3, p
```

И посчитать относительное изменение отношения шансов:

\[
\frac{P(y_{i} = j)}{P(y_{i} = 1)} = exp(x_{i}\beta)
\] - показывает изменение отношения шансов при выборе альтернативы j вместо альтернативы 0, если x изменился на единицу.
В stata, в отличие от R, отношение шансов называется relative-risk ratio.

```{stata "rrr",  message=FALSE, warning=FALSE}
mlogit, rrr
```


Можем посчитать предельные эффекты в разных точках.
```{stata "mfx",  message=FALSE, warning=FALSE}
margins, predict(outcome(0)) dydx(choice age educ wealth89 prftshr) atmeans 

margins, predict(outcome(0)) dydx(choice age educ wealth89 prftshr) at((p25) *)

margins, predict(outcome(0)) dydx(choice age educ wealth89 prftshr) at(age = 69, choice = 1)
```


И вернемся к ~~сильным и независимым~~ моделькам упорядоченного выбора :) 
```{stata "import tradrole stata",  message=FALSE, warning=FALSE}
use data/tradrole.dta'

sum
```

```{stata "hist tradrole stata",  message=FALSE, warning=FALSE}
hist tradrole 'Вот такие дела, джентельмены :)')
subtitle("Вот такие дела, джентельмены :)")
```

Посмотрим, как влияет религиозное воспитание (`cath` - католичество и `fpro` - протестанство), число лет образования матери - `meduc` и проживание в крупном городе `urb` на объясняемую переменную.

```{stata "ordered stata",  message=FALSE, warning=FALSE}
oprobit tradrole i.cath i.fpro meduc i.urb
```



